/**
 * LAS - Local Auto Save Plugin
 * localautosave/plugin.js
 *
 * Released under Creative Commons Attribution 3.0 Unported License
 *
 * License: http://creativecommons.org/licenses/by/3.0/
 * Plugin info: https://github.com/valtlfelipe/TinyMCE-LocalAutoSave
 * Author: Felipe Valtl de Mello
 *
 * Version: 0.2 released 23/09/2013
 */
tinymce.PluginManager.requireLangPack("localautosave");tinymce.PluginManager.add("localautosave",function(h,j){var l=$(h.formElement);var g=false;var o=false;var s=h.id;var f=false;var n={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"};var y={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"};var w={seconds:h.getParam("las_seconds")||5,keyName:h.getParam("las_keyName")||"LocalAutoSave",callback:h.getParam("las_callback")||function(){/*null*/}};var c=new RegExp("(?:^|;\\s*)"+w.keyName+s+"=([^;]*)(?:;|$)","i");try{localStorage.setItem("LASTest","OK");if(localStorage.getItem("LASTest")==="OK"){localStorage.removeItem("LASTest");g=true}}catch(r){try{sessionStorage.setItem("LASTest","OK");if(sessionStorage.getItem("LASTest")==="OK"){sessionStorage.removeItem("LASTest");o=true}}catch(r){}}var d=h.addButton("localautosave",{text:"",icon:"restoredraft",tooltip:"Restore content",onclick:function(){t()}});function q(z){return z.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(A){if(A.length>1){return("%0"+A.charAt(0)+A.length.toString()+"%")}return n[A]})}function v(z){return z.replace(/%[1-5]|%0(.)(\d+)%/g,function(F,A,E){var C,D,B;if(F.length==2){return y[F]}for(C=[],D=0,B=parseInt(E);D<B;D++){C.push(A)}return C.join("")})}function k(z){return z.replace(/,/g,"&#44;")}function p(z){return z.replace(/&#44;/g,",")}var u=function(){if(f===false&&h.isDirty()){content=h.getContent();is=h.editorManager.is;var C=false;if(is(content,"string")&&(content.length>0)){now=new Date();exp=new Date(now.getTime()+(20*60*1000));try{if(g){localStorage.setItem(w.keyName+s,exp.toString()+","+k(content))}else{if(o){sessionStorage.setItem(w.keyName+s,exp.toString()+","+k(content))}else{a=w.keyName+s+"=";b="; expires="+exp.toUTCString();document.cookie=a+q(content).slice(0,4096-a.length-b.length)+b}}C=true}catch(z){console.log(z)}if(C===true){obj=new Object();obj.content=content;obj.time=now.getTime();w.callback.call(obj);var B=e("localautosave");$(B).find("i").replaceWith('<i class="mce-ico mce-i-none" style="background: url(\''+j+"/img/progress.gif') no-repeat;\"></i>");var A=setTimeout(function(){$(B).find("i").replaceWith('<i class="mce-ico mce-i-restoredraft"></i>')},2000)}}}};var x=setInterval(u,w.seconds*1000);function t(){var B=null,A=h.editorManager.is;f=true;try{if(g||o){B=((g?localStorage.getItem(w.keyName+s):sessionStorage.getItem(w.keyName+s))||"").toString();i=B.indexOf(",");if(i==-1){B=null}else{B=p(B.slice(i+1,B.length))}}else{m=c.exec(document.cookie);if(m){B=v(m[1])}}if(!A(B,"string")){h.windowManager.alert("There is no content available to restore.")}else{if(h.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length===0){h.setContent(B);f=false}else{h.windowManager.confirm("If you restore the saved content, you will lose all the content that is currently in the editor.\n\nAre you sure you want to restore the saved content?",function(C){if(C){h.setContent(B)}f=false},this)}}}catch(z){console.log(z);f=false}}function e(z,B){var D=h,F=D.buttons,G=D.theme.panel.find("toolbar *"),E="undefined";if(typeof F[z]===E){return false}var C=F[z],H=false,A=0;tinymce.each(C,function(J,I){A++});tinymce.each(G,function(J,I){if(J.type!="button"||typeof J.settings===E){return}var K=0;tinymce.each(J.settings,function(M,L){if(C[L]==M){K++}});if(K!=A){return}H=J;if(B!=false){H=J.getEl()}return false});return H}});