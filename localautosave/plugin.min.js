/**
 * LAS - Local Auto Save Plugin
 * localautosave/plugin.js
 *
 * Released under Creative Commons Attribution 3.0 Unported License
 *
 * License: http://creativecommons.org/licenses/by/3.0/
 * Plugin info: https://github.com/valtlfelipe/TinyMCE-LocalAutoSave
 * Author: Felipe Valtl de Mello
 *
 * Version: 0.2 released 23/09/2013
 * 
 * Modified by Diego Valerio Camarda 
 * https://github.com/dvcama/TinyMCE-LocalAutoSave
 * 
 * 
 */
tinymce.PluginManager.requireLangPack("localautosave");tinymce.PluginManager.add("localautosave",function(e,t){function g(e){return e.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(e){if(e.length>1){return"%0"+e.charAt(0)+e.length.toString()+"%"}return l[e]})}function y(e){return e.replace(/%[1-5]|%0(.)(\d+)%/g,function(e,t,n){var r,i,s;if(e.length==2){return c[e]}for(r=[],i=0,s=parseInt(n);i<s;i++){r.push(t)}return r.join("")})}function w(e){return e.replace(/,/g,"&#44;")}function E(e){return e.replace(/&#44;/g,",")}function S(){var e=[];if(u){for(var t=0,n=u.length;t<n;t++){var r=u.key([t]);if(r.indexOf(h.keyName+s)==0){e.push(u.getItem(r))}}}else{}e.sort();return e.reverse()}function x(e){var t=[];if(u){for(var n=0,r=u.length;n<r;n++){var i=u.key([n]);if(i.indexOf(h.keyName+s)==0){t.push(i)}}}else{}t.sort(function(e,t){return u.getItem(e)>u.getItem(t)});t.reverse();if(e>0){var o=t;t=[];if(e<o.length){for(var n=e,r=o.length;n<r;n++){t.push(o[n])}}}return t}function T(e){if(u){for(var t=0,n=e.length;t<n;t++){u.removeItem(e[t])}}else{}}function k(){var t=null,n=e.editorManager.is;if(e.getContent().replace(/<\/?[a-z]+[^>]*>/gi,"").length>0){N()}o=true;try{if(u){var r=S();if(r.length===0){e.windowManager.alert("localautosave.noContent")}else{if(r.length===1&&e.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length===0){e.setContent(E(r[0].substring(r[0].indexOf(",")+1)));o=false}else{var i="<div class='localautosave_cnt' id=\""+s+"-popup-localautosave\"><ul id='localautosave_list'>";for(var a=0,f=r.length;a<f;a++){var l=E(r[a].substring(r[a].indexOf(",")+1));var c=r[a].substring(0,r[a].indexOf(","));i+="<li>"+c+" <tt>("+l.replace(/<\/?[a-z]+[^>]*>/gi,"").length+" "+tinymce.translate("localautosave.chars")+")</tt><span>"+l+"</span></li>"}i+="</ul></div>";e.windowManager.open({width:380,height:240,scrollbars:true,title:"localautosave.chooseVersion",html:i,buttons:[{text:"localautosave.clearAll",onclick:function(){T(x());tinyMCE.activeEditor.windowManager.close()}},{text:"Cancel",onclick:"close"}]});var h=$("#"+s+"-popup-localautosave").find("li");h.click(function(){tinyMCE.activeEditor.setContent($(this).children("span").html());tinyMCE.activeEditor.windowManager.close()})}}}else{m=p.exec(document.cookie);if(m){t=y(m[1])}}}catch(d){console.log(d);o=false}}function L(t,n){var r=e,i=r.buttons,s=r.theme.panel.find("toolbar *"),o="undefined";if(typeof i[t]===o)return false;var u=i[t],a=false,f=0;tinymce.each(u,function(e,t){f++});tinymce.each(s,function(e,t){if(e.type!="button"||typeof e.settings===o)return;var r=0;tinymce.each(e.settings,function(e,t){if(u[t]==e)r++});if(r!=f)return;a=e;if(n!=false)a=e.getEl();return false});return a}function A(){var e=".mce-container .localautosave_cnt , .mce-container * .localautosave_cnt , .mce-widget .localautosave_cnt , .mce-widget * .localautosave_cnt {padding:20px;} ";e+="#localautosave_list li {list-style:none;cursor:pointer;line-height:30px;border-bottom:1px solid #ddd;} ";e+="#localautosave_list li:hover {background-color:#ddd;} ";e+="#localautosave_list li span{display:none;} ";e+="#localautosave_list li tt{float:right;line-height: 30px;} ";e+="body .mce-container-body.mce-abs-layout {overflow: auto;} ";$("head").append("<style type='text/css'>"+e+"</style>")}function O(e,t){var n=e[0],r=e[1],i=e[2],s=e[3];n=_(n,r,i,s,t[0],7,-680876936);s=_(s,n,r,i,t[1],12,-389564586);i=_(i,s,n,r,t[2],17,606105819);r=_(r,i,s,n,t[3],22,-1044525330);n=_(n,r,i,s,t[4],7,-176418897);s=_(s,n,r,i,t[5],12,1200080426);i=_(i,s,n,r,t[6],17,-1473231341);r=_(r,i,s,n,t[7],22,-45705983);n=_(n,r,i,s,t[8],7,1770035416);s=_(s,n,r,i,t[9],12,-1958414417);i=_(i,s,n,r,t[10],17,-42063);r=_(r,i,s,n,t[11],22,-1990404162);n=_(n,r,i,s,t[12],7,1804603682);s=_(s,n,r,i,t[13],12,-40341101);i=_(i,s,n,r,t[14],17,-1502002290);r=_(r,i,s,n,t[15],22,1236535329);n=D(n,r,i,s,t[1],5,-165796510);s=D(s,n,r,i,t[6],9,-1069501632);i=D(i,s,n,r,t[11],14,643717713);r=D(r,i,s,n,t[0],20,-373897302);n=D(n,r,i,s,t[5],5,-701558691);s=D(s,n,r,i,t[10],9,38016083);i=D(i,s,n,r,t[15],14,-660478335);r=D(r,i,s,n,t[4],20,-405537848);n=D(n,r,i,s,t[9],5,568446438);s=D(s,n,r,i,t[14],9,-1019803690);i=D(i,s,n,r,t[3],14,-187363961);r=D(r,i,s,n,t[8],20,1163531501);n=D(n,r,i,s,t[13],5,-1444681467);s=D(s,n,r,i,t[2],9,-51403784);i=D(i,s,n,r,t[7],14,1735328473);r=D(r,i,s,n,t[12],20,-1926607734);n=P(n,r,i,s,t[5],4,-378558);s=P(s,n,r,i,t[8],11,-2022574463);i=P(i,s,n,r,t[11],16,1839030562);r=P(r,i,s,n,t[14],23,-35309556);n=P(n,r,i,s,t[1],4,-1530992060);s=P(s,n,r,i,t[4],11,1272893353);i=P(i,s,n,r,t[7],16,-155497632);r=P(r,i,s,n,t[10],23,-1094730640);n=P(n,r,i,s,t[13],4,681279174);s=P(s,n,r,i,t[0],11,-358537222);i=P(i,s,n,r,t[3],16,-722521979);r=P(r,i,s,n,t[6],23,76029189);n=P(n,r,i,s,t[9],4,-640364487);s=P(s,n,r,i,t[12],11,-421815835);i=P(i,s,n,r,t[15],16,530742520);r=P(r,i,s,n,t[2],23,-995338651);n=H(n,r,i,s,t[0],6,-198630844);s=H(s,n,r,i,t[7],10,1126891415);i=H(i,s,n,r,t[14],15,-1416354905);r=H(r,i,s,n,t[5],21,-57434055);n=H(n,r,i,s,t[12],6,1700485571);s=H(s,n,r,i,t[3],10,-1894986606);i=H(i,s,n,r,t[10],15,-1051523);r=H(r,i,s,n,t[1],21,-2054922799);n=H(n,r,i,s,t[8],6,1873313359);s=H(s,n,r,i,t[15],10,-30611744);i=H(i,s,n,r,t[6],15,-1560198380);r=H(r,i,s,n,t[13],21,1309151649);n=H(n,r,i,s,t[4],6,-145523070);s=H(s,n,r,i,t[11],10,-1120210379);i=H(i,s,n,r,t[2],15,718787259);r=H(r,i,s,n,t[9],21,-343485551);e[0]=U(n,e[0]);e[1]=U(r,e[1]);e[2]=U(i,e[2]);e[3]=U(s,e[3])}function M(e,t,n,r,i,s){t=U(U(t,e),U(r,s));return U(t<<i|t>>>32-i,n)}function _(e,t,n,r,i,s,o){return M(t&n|~t&r,e,t,i,s,o)}function D(e,t,n,r,i,s,o){return M(t&r|n&~r,e,t,i,s,o)}function P(e,t,n,r,i,s,o){return M(t^n^r,e,t,i,s,o)}function H(e,t,n,r,i,s,o){return M(n^(t|~r),e,t,i,s,o)}function B(e){txt="";var t=e.length,n=[1732584193,-271733879,-1732584194,271733878],r;for(r=64;r<=e.length;r+=64){O(n,j(e.substring(r-64,r)))}e=e.substring(r-64);var i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(r=0;r<e.length;r++)i[r>>2]|=e.charCodeAt(r)<<(r%4<<3);i[r>>2]|=128<<(r%4<<3);if(r>55){O(n,i);for(r=0;r<16;r++)i[r]=0}i[14]=t*8;O(n,i);return n}function j(e){var t=[],n;for(n=0;n<64;n+=4){t[n>>2]=e.charCodeAt(n)+(e.charCodeAt(n+1)<<8)+(e.charCodeAt(n+2)<<16)+(e.charCodeAt(n+3)<<24)}return t}function I(e){var t="",n=0;for(;n<4;n++)t+=F[e>>n*8+4&15]+F[e>>n*8&15];return t}function q(e){for(var t=0;t<e.length;t++)e[t]=I(e[t]);return e.join("")}function R(e){return q(B(e))}function U(e,t){return e+t&4294967295}function O(e,t){var n=e[0],r=e[1],i=e[2],s=e[3];n=_(n,r,i,s,t[0],7,-680876936);s=_(s,n,r,i,t[1],12,-389564586);i=_(i,s,n,r,t[2],17,606105819);r=_(r,i,s,n,t[3],22,-1044525330);n=_(n,r,i,s,t[4],7,-176418897);s=_(s,n,r,i,t[5],12,1200080426);i=_(i,s,n,r,t[6],17,-1473231341);r=_(r,i,s,n,t[7],22,-45705983);n=_(n,r,i,s,t[8],7,1770035416);s=_(s,n,r,i,t[9],12,-1958414417);i=_(i,s,n,r,t[10],17,-42063);r=_(r,i,s,n,t[11],22,-1990404162);n=_(n,r,i,s,t[12],7,1804603682);s=_(s,n,r,i,t[13],12,-40341101);i=_(i,s,n,r,t[14],17,-1502002290);r=_(r,i,s,n,t[15],22,1236535329);n=D(n,r,i,s,t[1],5,-165796510);s=D(s,n,r,i,t[6],9,-1069501632);i=D(i,s,n,r,t[11],14,643717713);r=D(r,i,s,n,t[0],20,-373897302);n=D(n,r,i,s,t[5],5,-701558691);s=D(s,n,r,i,t[10],9,38016083);i=D(i,s,n,r,t[15],14,-660478335);r=D(r,i,s,n,t[4],20,-405537848);n=D(n,r,i,s,t[9],5,568446438);s=D(s,n,r,i,t[14],9,-1019803690);i=D(i,s,n,r,t[3],14,-187363961);r=D(r,i,s,n,t[8],20,1163531501);n=D(n,r,i,s,t[13],5,-1444681467);s=D(s,n,r,i,t[2],9,-51403784);i=D(i,s,n,r,t[7],14,1735328473);r=D(r,i,s,n,t[12],20,-1926607734);n=P(n,r,i,s,t[5],4,-378558);s=P(s,n,r,i,t[8],11,-2022574463);i=P(i,s,n,r,t[11],16,1839030562);r=P(r,i,s,n,t[14],23,-35309556);n=P(n,r,i,s,t[1],4,-1530992060);s=P(s,n,r,i,t[4],11,1272893353);i=P(i,s,n,r,t[7],16,-155497632);r=P(r,i,s,n,t[10],23,-1094730640);n=P(n,r,i,s,t[13],4,681279174);s=P(s,n,r,i,t[0],11,-358537222);i=P(i,s,n,r,t[3],16,-722521979);r=P(r,i,s,n,t[6],23,76029189);n=P(n,r,i,s,t[9],4,-640364487);s=P(s,n,r,i,t[12],11,-421815835);i=P(i,s,n,r,t[15],16,530742520);r=P(r,i,s,n,t[2],23,-995338651);n=H(n,r,i,s,t[0],6,-198630844);s=H(s,n,r,i,t[7],10,1126891415);i=H(i,s,n,r,t[14],15,-1416354905);r=H(r,i,s,n,t[5],21,-57434055);n=H(n,r,i,s,t[12],6,1700485571);s=H(s,n,r,i,t[3],10,-1894986606);i=H(i,s,n,r,t[10],15,-1051523);r=H(r,i,s,n,t[1],21,-2054922799);n=H(n,r,i,s,t[8],6,1873313359);s=H(s,n,r,i,t[15],10,-30611744);i=H(i,s,n,r,t[6],15,-1560198380);r=H(r,i,s,n,t[13],21,1309151649);n=H(n,r,i,s,t[4],6,-145523070);s=H(s,n,r,i,t[11],10,-1120210379);i=H(i,s,n,r,t[2],15,718787259);r=H(r,i,s,n,t[9],21,-343485551);e[0]=U(n,e[0]);e[1]=U(r,e[1]);e[2]=U(i,e[2]);e[3]=U(s,e[3])}function M(e,t,n,r,i,s){t=U(U(t,e),U(r,s));return U(t<<i|t>>>32-i,n)}function _(e,t,n,r,i,s,o){return M(t&n|~t&r,e,t,i,s,o)}function D(e,t,n,r,i,s,o){return M(t&r|n&~r,e,t,i,s,o)}function P(e,t,n,r,i,s,o){return M(t^n^r,e,t,i,s,o)}function H(e,t,n,r,i,s,o){return M(n^(t|~r),e,t,i,s,o)}function B(e){txt="";var t=e.length,n=[1732584193,-271733879,-1732584194,271733878],r;for(r=64;r<=e.length;r+=64){O(n,j(e.substring(r-64,r)))}e=e.substring(r-64);var i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(r=0;r<e.length;r++)i[r>>2]|=e.charCodeAt(r)<<(r%4<<3);i[r>>2]|=128<<(r%4<<3);if(r>55){O(n,i);for(r=0;r<16;r++)i[r]=0}i[14]=t*8;O(n,i);return n}function j(e){var t=[],n;for(n=0;n<64;n+=4){t[n>>2]=e.charCodeAt(n)+(e.charCodeAt(n+1)<<8)+(e.charCodeAt(n+2)<<16)+(e.charCodeAt(n+3)<<24)}return t}function I(e){var t="",n=0;for(;n<4;n++)t+=F[e>>n*8+4&15]+F[e>>n*8&15];return t}function q(e){for(var t=0;t<e.length;t++)e[t]=I(e[t]);return e.join("")}function R(e){return q(B(e))}function U(e,t){return e+t&4294967295}var n=$(e.formElement);var r=false;var i=false;var s=e.id;var o=false;var u=localStorage;var f=null;var l={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"};var c={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"};var h={seconds:e.getParam("las_seconds")||6,keyName:e.getParam("las_keyName")||"LocalAutoSave",callback:e.getParam("las_callback"),versions:e.getParam("las_nVersions")||15};var p=new RegExp("(?:^|;\\s*)"+h.keyName+s+"=([^;]*)(?:;|$)","i");A();try{u.setItem("LASTest","OK");if(u.getItem("LASTest")==="OK"){u.removeItem("LASTest");r=true}}catch(d){try{u=sessionStorage;u.setItem("LASTest","OK");if(u.getItem("LASTest")==="OK"){u.removeItem("LASTest");i=true}}catch(d){u=null}}var v=e.addButton("localautosave",{text:"",icon:"restoredraft",tooltip:"localautosave.restoreContent",onclick:function(){N();while(!o){k()}}});var N=function(){if(!o&&e.isDirty()){o=true;content=e.getContent();is=e.editorManager.is;var n=false;if(is(content,"string")&&content.length>0){now=new Date;exp=new Date(now.getTime()+20*60*1e3);var r=h.keyName+s;if(h.versions>0){r=r+R(content)}if(h.versions===0||f!=r){try{if(u){if(!u.getItem(r)){u.setItem(r,now.toISOString().replace(/T/g," ").replace(/\.[0-9]*Z$/g,"")+","+w(content))}}else{a=r+"=";b="; expires="+exp.toUTCString();document.cookie=a+g(content).slice(0,4096-a.length-b.length)+b}n=true}catch(i){console.log(i)}if(n){obj=new Object;obj.content=content;obj.time=now.getTime();if(h.callback){h.callback.call(obj)}var l=L("localautosave");$(l).find("i").replaceWith('<i class="mce-ico mce-i-none" style="background: url(\''+t+"/img/progress.gif') no-repeat;\"></i>");var c=setTimeout(function(){$(l).find("i").replaceWith('<i class="mce-ico mce-i-restoredraft"></i>')},2e3)}}if(n){f=r}if(h.versions>0){T(x(h.versions))}}}o=false};var C=setInterval(N,h.seconds*1e3);var F="0123456789abcdef".split("");if(R("hello")!="5d41402abc4b2a76b9719d911017c592"){function U(e,t){var n=(e&65535)+(t&65535),r=(e>>16)+(t>>16)+(n>>16);return r<<16|n&65535}}var F="0123456789abcdef".split("");if(R("hello")!="5d41402abc4b2a76b9719d911017c592"){function U(e,t){var n=(e&65535)+(t&65535),r=(e>>16)+(t>>16)+(n>>16);return r<<16|n&65535}}})